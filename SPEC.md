# 设备运行数据分析系统 - 技术方案

## 一、系统概述

### 1.1 项目背景
- **用途**: 厂部内部设备运行数据分析
- **数据格式**: MDB (Microsoft Access)、SQL Server备份(.bak)、MySQL导出文件
- **核心功能**: 上传数据库文件 → 解析数据 → AI智能分析 → 返回分析结果
- **部署方式**: Web + 桌面客户端 (双端支持)

### 1.2 系统架构
```
┌─────────────────────────────────────────────────────────────────┐
│                        客户端层                                   │
│  ┌─────────────────────┐         ┌─────────────────────────┐   │
│  │   Web浏览器端        │         │   桌面客户端 (Electron)  │   │
│  │   Vue3 + Element+   │         │   Tauri/Electron        │   │
│  └─────────────────────┘         └─────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        API网关层 (Nginx)                          │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      应用服务层 (FastAPI)                         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐   │
│  │ 文件上传服务  │  │ 数据解析服务 │  │   AI智能分析服务        │   │
│  │ (MDB解析)    │  │ (pandas)    │  │   (LangChain + Agent)  │   │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        数据存储层                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐   │
│  │ PostgreSQL  │  │ 本地文件存储 │  │   Redis (缓存)          │   │
│  │ (分析结果)   │  │ (MDB/原始)  │  │   (会话/状态)           │   │
│  └─────────────┘  └─────────────┘  └─────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      AI模型层 (可切换)                           │
│  ┌─────────────────────┐         ┌─────────────────────────┐     │
│  │ DeepSeek API        │         │   本地模型 (Ollama)     │     │
│  │ (在线云端)           │         │   (完全离线/内网)       │     │
│  └─────────────────────┘         └─────────────────────────┘     │
└─────────────────────────────────────────────────────────────────┘
```

---

## 二、技术选型

### 2.1 后端技术栈
| 技术 | 用途 | 版本 |
|------|------|------|
| **FastAPI** | Web框架 | 0.109+ |
| **SQLAlchemy** | ORM | 2.0+ |
| **pandas** | 数据处理 | 2.0+ |
| **pyodbc** | MDB解析 | 4.0+ |
| **LangChain** | AI Agent框架 | 0.2+ |
| **pydantic** | 数据验证 | 2.0+ |

### 2.2 前端技术栈 (Web)
| 技术 | 用途 |
|------|------|
| **Vue3** | 框架 |
| **Element Plus** | UI组件库 |
| **Axios** | HTTP请求 |
| **Pinia** | 状态管理 |

### 2.3 桌面客户端
| 技术 | 用途 |
|------|------|
| **Tauri** | Rust内核，更轻量 |
| **Electron** (备选) | 更成熟的生态 |

### 2.4 AI模型支持
- **DeepSeek API**: 性价比高，适合联网环境
- **Ollama + 本地模型**: 完全离线，数据安全

---

## 三、核心功能设计

### 3.1 MDB文件解析模块
```python
# 核心功能
class MDBParser:
    def parse_file(file_path: str) -> Dict:
        """解析MDB文件，返回所有表和数据"""
    
    def get_table_schema(table_name: str) -> List[Column]:
        """获取表结构"""
    
    def export_to_json(table_data: DataFrame) -> str:
        """转换为JSON格式便于前端展示"""
```

### 3.2 AI智能体设计
```python
# 设备数据分析智能体
class EquipmentAnalysisAgent:
    def analyze(data: DataFrame, query: str) -> str:
        """基于数据进行分析"""
    
    def detect_anomalies(data: DataFrame) -> List[Dict]:
        """异常检测"""
    
    def generate_report(data: DataFrame) -> str:
        """生成分析报告"""
```

### 3.3 数据流转
```
用户上传MDB 
    → 后端接收文件 
    → pyodbc读取数据 
    → pandas处理 
    → 存储到本地/数据库 
    → 调用AI分析 
    → 返回结果
```

---

## 四、数据库设计

### 4.1 分析记录表 (analysis_records)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| file_name | VARCHAR | 原始文件名 |
| file_size | BIGINT | 文件大小 |
| table_count | INT | 表的数量 |
| record_count | INT | 总记录数 |
| analysis_result | TEXT | AI分析结果(JSON) |
| status | VARCHAR | 状态: pending/completed/failed |
| created_at | DATETIME | 创建时间 |
| completed_at | DATETIME | 完成时间 |

### 4.2 原始数据表 (raw_data)
| 字段 | 类型 | 说明 |
|------|------|------|
| id | UUID | 主键 |
| record_id | UUID | 分析记录ID |
| table_name | VARCHAR | 表名 |
| data | JSONB | 原始数据 |

---

## 五、API设计

### 5.1 核心接口
| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/v1/upload | 上传MDB文件 |
| GET | /api/v1/records | 获取分析记录列表 |
| GET | /api/v1/records/{id} | 获取分析详情 |
| POST | /api/v1/analyze | 发起AI分析 |
| GET | /api/v1/tables/{record_id} | 获取数据表列表 |
| GET | /api/v1/tables/{record_id}/{table_name} | 获取表数据 |

---

## 六、安全考虑

1. **文件安全**: 限制上传文件大小(50MB)，验证文件类型
2. **数据隔离**: 每个用户的分析数据独立存储
3. **AI模型切换**: 支持在线/离线模型切换，适应不同安全级别场景

---

## 七、部署方案

### 7.1 开发环境
- Python 3.10+
- Node.js 18+
- Ollama (本地模型，可选)

### 7.2 生产环境
- Docker Compose 一键部署
- Nginx 反向代理
- 支持高并发场景

---

## 八、实施计划

1. **Phase 1**: 后端MDB解析 + 基础API
2. **Phase 2**: AI智能体开发 (支持DeepSeek/Ollama切换)
3. **Phase 3**: Web前端开发
4. **Phase 4**: 桌面客户端开发 (Tauri)
5. **Phase 5**: 集成测试与优化

---

*方案版本: v1.0*
*创建日期: 2026-02-27*
